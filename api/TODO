The handling of embedded double-quotes in some places needs tidying up.
